<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Simple Chat Pro</title>

    <!-- Th·∫ª n√†y gi√∫p hi·ªÉn th·ªã chu·∫©n tr√™n ƒëi·ªán tho·∫°i -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Poppins, Arial;
            background: #1c1f22;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            margin: 0;
        }

        .chat-container {
            /* [S·ª¨A] ƒê·ªïi width c·ªë ƒë·ªãnh th√†nh linh ho·∫°t */
            width: 100%;
            max-width: 420px; 
            height: 80vh; /* Chi·ªÅu cao c·ªë ƒë·ªãnh tr√™n Desktop */
            background: #2b2f33;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
        }

        /* [TH√äM] CSS cho ƒëi·ªán tho·∫°i */
        @media (max-width: 480px) {
            .chat-container {
                height: 100vh; /* Full m√†n h√¨nh tr√™n ƒëi·ªán tho·∫°i */
                max-width: 100%;
                border-radius: 0;
                padding: 10px;
            }
        }

        .title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
        }

        #messageArea {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* [S·ª¨A] ƒê·ªÉ khung chat t·ª± co gi√£n chi·∫øm h·∫øt kho·∫£ng tr·ªëng */
            flex-grow: 1; 
            overflow-y: auto;
            scrollbar-width: thin;
            padding-right: 5px;
        }

        #messageArea::-webkit-scrollbar { width: 6px; }
        #messageArea::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }
        #messageArea::-webkit-scrollbar-track { background: #2b2f33; }

        #messageArea li {
            list-style: none;
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .my-message {
            background: #006eff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .other-message {
            background: #3a3f45;
            color: #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        /* T√™n ng∆∞·ªùi g·ª≠i tin nh·∫Øn kh√°c */
        .sender-name {
            font-size: 11px;
            color: #aaa;
            margin-bottom: 2px;
            display: block;
        }

        .join, .leave {
            text-align: center;
            font-size: 12px;
            align-self: center; /* CƒÉn gi·ªØa khung chat */
            max-width: 100% !important;
            background: transparent !important;
            padding: 2px !important;
        }
        .join { color: #28c76f; }
        .leave { color: #ff9f43; }

        .input-row {
            display: flex;
            margin-top: 10px;
            flex-shrink: 0;
        }
        input {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid #444;
            outline: none;
            background: #3b4047;
            color: white;
            font-size: 14px;
        }
        input:focus { border-color: #006eff; }
        button {
            margin-left: 8px;
            padding: 0 20px;
            border-radius: 20px;
            background: #006eff;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        button:hover { background: #0056cb; }
        
        #username-page { text-align: center; margin-top: 50%; transform: translateY(-50%); }
        #chat-page { display: none; height: 100%; flex-direction: column; }
    </style>
</head>

<body>

<div class="chat-container">
    <div id="username-page">
        <div class="title">Nh·∫≠p t√™n ƒë·ªÉ Chat</div>
        <input type="text" id="name" placeholder="T√™n c·ªßa b·∫°n..." style="width: 70%; margin-bottom: 10px;">
        <br>
        <button onclick="connect()" style="width: 50%; padding: 10px;">V√†o ngay</button>
    </div>

    <div id="chat-page">
        <div class="title">Ph√≤ng Chat Chung üåê</div>
        <ul id="messageArea"></ul>

        <div class="input-row">
            <input type="text" id="message" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off"
                onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>

<script>
    var stompClient = null;
    var username = null;

    function connect() {
        username = document.getElementById("name").value.trim();
        if (!username) return;

        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            document.getElementById("username-page").style.display="none";
            // S·ª≠ d·ª•ng flex ƒë·ªÉ gi·ªØ b·ªë c·ª•c chu·∫©n
            document.getElementById("chat-page").style.display="flex"; 

            // 1. ƒêƒÉng k√Ω nh·∫≠n tin m·ªõi
            stompClient.subscribe("/topic/public",
                (payload)=> showMessage(JSON.parse(payload.body))
            );

            // 2. [M·ªöI] T·∫£i l·ªãch s·ª≠ tin nh·∫Øn c≈©
            loadHistory();

            // 3. G·ª≠i th√¥ng b√°o JOIN
            stompClient.send("/app/chat.addUser", {}, 
                JSON.stringify({ sender: username, type: "JOIN" })
            );
        }, onError);
    }

    // H√†m t·∫£i l·ªãch s·ª≠ (G·ªçi API Backend)
    function loadHistory() {
        fetch('/api/chat/history')
            .then(response => {
                if(!response.ok) throw new Error("Ch∆∞a c√≥ API history");
                return response.json();
            })
            .then(messages => {
                messages.forEach(msg => showMessage(msg));
            })
            .catch(error => console.log("L·ªói t·∫£i history (c√≥ th·ªÉ do ch∆∞a code Backend):", error));
    }

    function sendMessage() {
        var msgInput = document.getElementById("message");
        var msgContent = msgInput.value.trim();
        
        if(msgContent && stompClient) {
            var chatMessage = {
                sender: username,
                content: msgContent,
                type: 'CHAT'
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            msgInput.value = "";
        }
    }

    function showMessage(message) {
        var area = document.getElementById("messageArea");
        var li = document.createElement("li");

        if(message.type === "JOIN") {
            li.className="join";
            li.textContent = message.sender + " ƒë√£ tham gia ph√≤ng chat";
        }
        else if(message.type === "LEAVE") {
            li.className="leave";
            li.textContent = message.sender + " ƒë√£ r·ªùi ph√≤ng";
        }
        else {
            // Tin nh·∫Øn Chat
            if (message.sender === username) {
                li.className = "my-message";
                li.innerHTML = `${message.content}`;
            } else {
                li.className = "other-message";
                // Hi·ªán th√™m t√™n ng∆∞·ªùi g·ª≠i n·∫øu l√† ng∆∞·ªùi kh√°c
                li.innerHTML = `<span class="sender-name">${message.sender}</span>${message.content}`;
            }
        }

        area.appendChild(li);
        // T·ª± ƒë·ªông cu·ªôn xu·ªëng cu·ªëi c√πng
        area.scrollTop = area.scrollHeight;
    }

    function onError(error) {
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Server! Vui l√≤ng ki·ªÉm tra l·∫°i m·∫°ng.");
    }
</script>

</body>
</html>